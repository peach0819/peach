<!DOCTYPE html>
<html>
    <head>
        <title>产品组 : 1. 指定月份提货卡充值计算预估毛利--已删除</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">产品组</a></span>
                            </li>
                                                    <li>
                                <span><a href="70335729.html">01_数据逻辑及模型设计思路</a></span>
                            </li>
                                                    <li>
                                <span><a href="59212908.html">四、毛利</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            产品组 : 1. 指定月份提货卡充值计算预估毛利--已删除
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> 未知用户 (lei.xue)</span>, last modified on 2022-10-26
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 class="auto-cursor-target" id="id-1.指定月份提货卡充值计算预估毛利已删除-修订记录"><strong>修订记录</strong></h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th style="text-align: left;" class="confluenceTh"><p>版本号</p></th><th style="text-align: left;" class="confluenceTh"><p>内容</p></th><th style="text-align: left;" class="confluenceTh"><p>作者</p></th><th style="text-align: left;" class="confluenceTh"><p>时间</p></th><th colspan="1" style="text-align: left;" class="confluenceTh"><p>备注</p></th></tr></thead><tbody><tr><td colspan="1" class="confluenceTd">V1</td><td colspan="1" class="confluenceTd">初稿</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">20.12.31</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">V1.1</td><td colspan="1" class="confluenceTd">PM组织沟通进度后,补充一下 人肉上传预估毛利表 的线下校验规则</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">21.02.20</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p>`<style type='text/css'>/*<![CDATA[*/
div.rbtoc1702954326295 {padding: 0px;}
div.rbtoc1702954326295 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1702954326295 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1702954326295'>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-修订记录'>修订记录</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-业务背景'>业务背景</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-业务过程与实际毛利'>业务过程与实际毛利</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-业务过程'>业务过程</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-场景模拟'>场景模拟</a></li>
</ul>
</li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-需求明细'>需求明细</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-一、新增人肉上传预估毛利表及指定月份特殊逻辑'>一、新增 人肉上传预估毛利表 及 指定月份特殊逻辑</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-业务场景:'>业务场景:</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-更新频率:'>更新频率:</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-校验规则:(V1.1新增)'>校验规则:(V1.1新增)</a></li>
</ul>
</li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-提货卡算毛利指定月份'>提货卡算毛利指定月份</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-二、新增产品化-抵扣充值预估毛利'>二、新增产品化- 抵扣充值预估毛利</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-需求明细.1'>需求明细</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-计算步骤'>计算步骤</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-一、指定待追回的退款单'>一、指定待追回的退款单</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-二、计算每个退款单对应的充值抵扣预估毛利'>二、计算每个退款单对应的 充值抵扣预估毛利</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-三、生成记录并制定对应的字段(维度和数值)'>三、生成记录并制定对应的字段(维度和数值)</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-四、合并回结果表(gross_profit_all)'>四、合并回 结果表(gross_profit_all)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-三、新增产品化-抵扣转实货预估毛利'>三、新增产品化- 抵扣转实货预估毛利</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-需求明细.2'>需求明细</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-计算步骤.1'>计算步骤</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-一、指定待追回的订单或者退款单'>一、指定待追回的订单或者退款单</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-二、计算每个订单/退款单对应的符合条件的提货hi卡及其预估毛利率明细'>二、计算每个订单/退款单对应的  符合条件的 提货hi卡 及其预估毛利率 明细</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-三、计算每个订单/退款单对应的抵扣转实货预估毛利'>三、计算每个订单/退款单对应的  抵扣转实货预估毛利</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-四、生成记录并制定对应的字段(维度和数值)'>四、生成记录并制定对应的字段(维度和数值)</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-五、合并回结果表(gross_profit_all)'>五、合并回 结果表(gross_profit_all)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-其他'>其他</a>
<ul class='toc-indentation'>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-问题一清退场景问题'>问题一 清退场景问题</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-问题二业务组和渠道归属为卡券票的问题'>问题二 业务组和渠道归属为卡券票的问题</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-问题三原路退时,优先退提货卡问题'>问题三 原路退时,优先退提货卡问题</a></li>
<li><a href='#id-1.指定月份提货卡充值计算预估毛利已删除-问题四关于提货卡充值时和实际使用时对应的业务组,渠道出现不一致的情况'>问题四 关于提货卡充值时 和 实际使用时 对应的 业务组,渠道 出现不一致的情况</a></li>
</ul>
</li>
</ul>
</div></p><h1 id="id-1.指定月份提货卡充值计算预估毛利已删除-业务背景">业务背景</h1><p>一般情况下, 只有实货订单才会计入毛利. 但是因为每年12月份冲提货卡的特别情况,业务要求提货卡充值也要算毛利. 即便充提货卡后还未达成真实的交易. </p><p>12.29日跟小样最终确认,  线上的毛利报表继续用 实货口径 计算毛利. 但是12月属于 大促提货卡充值月份. 如果毛利不算,则不符合业务场景..  因此 由财务手动做账.  </p><p><strong>即 每年的12月份的 提货卡充值 直接计入毛利.其他月份则正常按实货口径统计. </strong></p><p>因为时间问题,让财务线下手动将 提货卡订单(产品化默认毛利为0) 的毛利预估出来,并纳入当月的考核.</p><p>剩下的一些与之相关的业务,例如提货卡转销卡,提货卡转实货. 这些时间跨度太长.因此需要进行产品化计算. 即以下几个相关的需求</p><p><strong><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="400" src="attachments/56046716/56050890.png" data-image-src="attachments/56046716/56050890.png" data-unresolved-comment-count="0" data-linked-resource-id="56050890" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-7_18-16-22.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="56046716" data-linked-resource-container-version="31"></span></strong></p><h1 id="id-1.指定月份提货卡充值计算预估毛利已删除-业务过程与实际毛利">业务过程与实际毛利</h1><h2 id="id-1.指定月份提货卡充值计算预估毛利已删除-业务过程">业务过程</h2><p>以下所有的流程,都是基于 现有的线上毛利报表是 实货口径 来计算毛利 这个大背景下. 且仅因为业务上只需要针对 12月份充值的提货卡进行特殊处理.   以下仅针对12月份充值的提货卡来单独处理. </p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 68.4018%;"><colgroup><col style="width: 14.9316%;"/><col style="width: 9.2207%;"/><col style="width: 17.6681%;"/><col style="width: 19.1553%;"/><col style="width: 39.0244%;"/></colgroup><tbody><tr><th class="confluenceTh">业务过程</th><th class="confluenceTh">发生时间段</th><th class="confluenceTh">计算方式</th><th colspan="1" class="confluenceTh">现有线上化</th><th class="confluenceTh">最终线上化毛利计算逻辑</th></tr><tr><td class="confluenceTd">12月充值提货卡</td><td class="confluenceTd">12月</td><td class="confluenceTd">新增手动计算</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">当前 提货卡口径业绩归属团队 考核毛利额 = 提货卡余额 * 预估毛利率</td></tr><tr><td colspan="1" class="confluenceTd"><p>12月提货卡销卡</p><p>(提货卡充值订单的退款就是销卡)</p></td><td colspan="1" class="confluenceTd">12月</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd">默认为0</td><td colspan="1" class="confluenceTd">继续默认为 0 </td></tr><tr><td class="confluenceTd">12月充值12月用或者退款或者清退</td><td class="confluenceTd">12月</td><td class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd">实际转实货部分计算为 毛利额</td><td class="confluenceTd">保持不变</td></tr><tr><td rowspan="2" class="confluenceTd">后续转实货</td><td rowspan="2" class="confluenceTd">非12月</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd">转实货部分即为毛利额</td><td colspan="1" class="confluenceTd">保持不变</td></tr><tr><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue">新增产品化- 抵扣转实货预估毛利</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">考核毛利额 = 指定提货卡支付金额 * 该品牌的预估毛利 * -1 </td></tr><tr><td rowspan="2" class="confluenceTd"><p>后续销卡</p><p>(提货卡充值订单的退款就是销卡)</p></td><td rowspan="2" class="confluenceTd">非12月</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd">默认为0</td><td colspan="1" class="confluenceTd">继续默认为 0 </td></tr><tr><td class="highlight-red confluenceTd" colspan="1" data-highlight-colour="red">新增产品化- 抵扣充值预估毛利</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>考核毛利额 = 退款GMV * 该品牌的预估毛利 * -1  </p><p>退款GMV详见前面的 <a href="54521590.html">3. 退款GMV</a></p></td></tr><tr><td rowspan="2" class="confluenceTd">后续转实货退款</td><td rowspan="2" class="confluenceTd">非12月</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd">即转实货退款部分即为负数毛利额</td><td colspan="1" class="confluenceTd">保持不变</td></tr><tr><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue">新增产品化- 抵扣转实货预估毛利</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>考核毛利额 = 指定提货卡支付退款金额 * 该品牌的预估毛利 </p><p>即 考核毛利额 = 指定提货卡支付金额* 退款比例 * 该品牌的预估毛利 </p><p><span style="color: rgb(255,0,0);">退款比例问题详见问题3</span></p></td></tr><tr><td rowspan="2" class="confluenceTd">后续转实货清退</td><td rowspan="2" class="confluenceTd">非12月</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd">即转实货退款部分即为负数毛利额</td><td colspan="1" class="confluenceTd">保持不变</td></tr><tr><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue">新增产品化- 抵扣转实货预估毛利</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>考核毛利额 = 指定提货卡支付退款金额 * 该品牌的预估毛利 * </p><p>即 考核毛利额 = 指定提货卡支付金额* 退款比例 * 该品牌的预估毛利 .</p><p><span style="color: rgb(255,0,0);">清退没有原路退的问题.详见 问题1</span></p></td></tr></tbody></table></div><h2 class="auto-cursor-target" id="id-1.指定月份提货卡充值计算预估毛利已删除-场景模拟"><span style="letter-spacing: -0.01em;">场景模拟</span></h2><p>假设该品牌实际毛利率为恒定的 15%.  预估出的理论毛利率为10%.</p><p>这里分为了 线上化毛利公式 和 实际毛利.  仅作为描述 业务场景中, 出现退款时的问题. 为了保证计算的流程性,因此简化了 清退和优先退提货卡 的计算逻辑. </p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 81.0289%;"><colgroup><col style="width: 10.9914%;"/><col style="width: 16.6383%;"/><col style="width: 11.8989%;"/><col style="width: 14.2686%;"/><col style="width: 18.8567%;"/><col style="width: 27.0751%;"/></colgroup><tbody><tr><th colspan="1" class="confluenceTh">业务过程</th><th colspan="1" class="confluenceTh">业务动作描述</th><th colspan="1" class="confluenceTh">订单流水时间</th><th colspan="1" class="confluenceTh">计算方式</th><th colspan="1" class="confluenceTh">线上化毛利公式(未填写则同右)</th><th class="confluenceTh">实际毛利(仅供参考,作对比使用)</th></tr><tr><td colspan="1" class="confluenceTd">12月充值提货卡</td><td colspan="1" class="confluenceTd">充值提货卡-100万</td><td colspan="1" class="confluenceTd">12月15日</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">0</td></tr><tr><td colspan="1" class="confluenceTd">12月充值12月用或者退款或者清退</td><td colspan="1" class="confluenceTd">提货卡转实货-20万</td><td colspan="1" class="confluenceTd">12月20日</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">20万* 15% =  3万</td></tr><tr><td colspan="1" class="confluenceTd">12月充值提货卡</td><td colspan="1" class="confluenceTd">提货卡余额转毛利-即剩下80万</td><td colspan="1" class="confluenceTd">---人肉计算</td><td colspan="1" class="confluenceTd">新增手动计算</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">80万* 10% = 8万</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">---截止统计</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" data-highlight-colour="green"><p>12月共计 11万毛利.</p><p>其中, 有80万GMV是预估毛利 20万GMV是实货. </p></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td rowspan="3" class="confluenceTd">后续转实货</td><td colspan="1" class="confluenceTd">提货卡转实货50万-不用其他支付</td><td colspan="1" class="confluenceTd">1月5日</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">50*15% = 7.5万</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">---产品化抵扣</td><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue">新增产品化- 抵扣转实货预估毛利</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">50*10%* -1 = -5万</td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">---截止统计</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">累计产生 13.5万的毛利.   70万是实货的毛利. 30万是预估的毛利 </td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td rowspan="3" class="confluenceTd">后续转实货退款</td><td colspan="1" class="confluenceTd">提货卡转实货的订单退款-退款20万</td><td colspan="1" class="confluenceTd">1月10日</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">-20*15% =  - 3万</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">---产品化抵扣</td><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue">新增产品化- 抵扣转实货预估毛利</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">-20*10%*-1 = 2 万</td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">---截止统计</td><td class="highlight-green confluenceTd" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" data-highlight-colour="green">累计产生 12.5万的毛利.  50万是实货的毛利 . 50万是预估的毛利</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>提货卡销卡-10万</p><p>(提货卡充值订单的退款就是销卡)</p></td><td colspan="1" class="confluenceTd">1月15日</td><td colspan="1" class="confluenceTd">现有产品化</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>0</p></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">---产品化抵扣</td><td class="highlight-red confluenceTd" colspan="1" data-highlight-colour="red"><span style="color: rgb(23,43,77);" title="">新增产品化- 抵扣充值预估毛利</span></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>-10* 10% = -1万</p><p><span style="color: rgb(255,0,0);">注意,这里的业务组和渠道都是卡券票 . 要用 提货卡口径的来做补回, <strong>或者强行置回 业务组和渠道. </strong></span></p></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">---截止统计</td><td class="highlight-green confluenceTd" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" data-highlight-colour="green">累计产生 11.5万的毛利.  50万是实货的毛利 . 40万是预估的毛利</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">组合支付. 指定提货卡付10万, 其他渠道付10万.共计20万</td><td colspan="1" class="confluenceTd">1月16日</td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">现有产品化</span></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">20 * 15% = 3 万</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">---产品化抵扣</td><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue"><span style="color: rgb(23,43,77);" title="">新增产品化- 抵扣转实货预估毛利</span></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">10*-10% = -1万</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">---截止统计</td><td class="highlight-green confluenceTd" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" data-highlight-colour="green"><p>累计产生 13.5万的毛利. </p><p>跟指定提货卡相关的 : 60万是实货的毛利 . 30万是预估的毛利</p><p>其他渠道相关的 : 10万 </p></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><p>退掉上面的订单. 只退 15万. </p><p>实际流水,是 hi卡优先, 退提货卡支付10万, 其他渠道5万</p></td><td colspan="1" class="confluenceTd">1月17日</td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">现有产品化</span></td><td colspan="1" class="confluenceTd"><p>-15万 * 15% =  -2.25万元. </p></td><td colspan="1" class="confluenceTd">-15万 * 15% =  -2.25万元. </td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">--产品化抵扣</td><td class="highlight-blue confluenceTd" colspan="1" data-highlight-colour="blue"><span style="color: rgb(23,43,77);" title="">新增产品化- 抵扣转实货预估毛利</span></td><td colspan="1" class="confluenceTd"><p><span style="color: rgb(23,43,77);">考核毛利额 = 指定提货卡支付金额* 退款比例 * 该品牌的预估毛利 </span></p><p><span style="color: rgb(23,43,77);">10万 *  退款比例(15/20) *  10% *  =  0.75万 </span></p></td><td colspan="1" class="confluenceTd">10万 * 10% = 1万</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">---截止统计</td><td class="highlight-green confluenceTd" data-highlight-colour="green"><br/></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><p>累计产生<span style="color: rgb(255,0,0);"> 12万</span>的毛利. </p><p>跟指定提货卡相关的 : 50万是实货的毛利 . 40万是预估的毛利</p><p>其他渠道相关的 : 5万 </p><p>部分退款</p><p>这里严格来讲与实际场景不符合.</p><p>但是考虑到影响范围及其逻辑复杂性,简化了计算过程.  </p><p>详见 问题三 原路退时,优先退提货卡问题</p></td><td class="highlight-green confluenceTd" data-highlight-colour="green"><p>累计产生 12.25万的毛利. </p><p>跟指定提货卡相关的 : 50万是实货的毛利 . 40万是预估的毛利</p><p>其他渠道相关的 : 5万 </p></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><h1 id="id-1.指定月份提货卡充值计算预估毛利已删除-需求明细">需求明细</h1><h2 id="id-1.指定月份提货卡充值计算预估毛利已删除-一、新增人肉上传预估毛利表及指定月份特殊逻辑">一、新增 人肉上传预估毛利表 及 指定月份特殊逻辑</h2><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-业务场景:"><strong>业务场景:</strong></h3><p>通过该表格来维护, 哪个月的提货卡是要专门处理成毛利的. 以及 对应的处理毛利的 预估毛利率的分布情况. </p><p>考虑到业务可能会中途调整. 为了避免信息无法记录,请用 is_deleted 等字段对多次重复上传的数据进行隔离. 不要直接覆盖掉. 且不要用分区表.</p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 30.8625%;"><colgroup><col style="width: 13.6393%;"/><col style="width: 51.6721%;"/><col style="width: 20.0656%;"/><col style="width: 14.2951%;"/></colgroup><tbody><tr><th colspan="1" class="confluenceTh"><br/></th><th colspan="1" class="confluenceTh">上传日期</th><th colspan="1" class="confluenceTh">订单编号</th><th colspan="1" class="confluenceTh">预估毛利率</th></tr><tr><td colspan="1" class="confluenceTd">定义</td><td colspan="1" class="confluenceTd">随意填写.只是做一个记录</td><td colspan="1" class="confluenceTd">当时充值月份的提货卡</td><td colspan="1" class="confluenceTd">小数点截止到五位</td></tr><tr><td colspan="1" class="confluenceTd">举例1</td><td colspan="1" class="confluenceTd">20220105</td><td colspan="1" class="confluenceTd">订单号001</td><td colspan="1" class="confluenceTd">0.11111</td></tr><tr><td colspan="1" class="confluenceTd">举例2</td><td colspan="1" class="confluenceTd">20220105</td><td colspan="1" class="confluenceTd">订单号002</td><td colspan="1" class="confluenceTd">0.22222</td></tr><tr><td colspan="1" class="confluenceTd">举例3</td><td colspan="1" class="confluenceTd">20220105</td><td colspan="1" class="confluenceTd">订单号003</td><td colspan="1" class="confluenceTd">0.33333</td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-更新频率:">更新频率:</h3><p>目前的业务情况是 1年/次.  即每年的12月份为全年大促, 在次月初对 12月份的 提货卡充值订单进行预估毛利上传</p><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-校验规则:(V1.1新增)"><strong>校验规则:<span style="color: rgb(255,0,0);">(V1.1新增)</span></strong></h3><p>因为 上传的表格为 业务方提供,可能存在 极端情况下, 业务方提供的数据 不精准. 导致毛利报表计算有误.  </p><p>因此新增 校验规则. 以尽可能简单的形式进行校验,确保不会产生问题. </p><p>(这个阶段会先由PD 阿雷进行初次校验.  )</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">字段</th><th class="confluenceTh">校验规则</th></tr><tr><td class="confluenceTd">上传日期</td><td class="confluenceTd">无所谓. 不涉及到任何规则</td></tr><tr><td class="confluenceTd">订单编号</td><td class="confluenceTd"><p>以下需要同时满足</p><p>1) 是正确的订单编号 (trade_no)</p><p>2) 该订单的支付时间 必须在 当年的12月份</p><p>3) 该订单必须为 提货卡充值订单</p><p>4) 不能重复</p></td></tr><tr><td colspan="1" class="confluenceTd">预估毛利率</td><td colspan="1" class="confluenceTd"><p>以下需要同时满足</p><p>1) 格式必须为 数值</p><p>2) 数值必须&gt;=0 且 &lt;1 . </p></td></tr></tbody></table></div><h2 id="id-1.指定月份提货卡充值计算预估毛利已删除-提货卡算毛利指定月份">提货卡算毛利指定月份</h2><p>目前暂定为每个年的12月份为 提货卡算毛利指定月份. 下文的所有判断都是基于这个月份来进行判断. </p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">月份</th><th class="confluenceTh">备注</th></tr><tr><td class="confluenceTd">202012</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">202112</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr></tbody></table></div><h2 id="id-1.指定月份提货卡充值计算预估毛利已删除-二、新增产品化-抵扣充值预估毛利">二、<span style="color: rgb(23,43,77);">新增产品化- 抵扣充值预估毛利</span></h2><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-需求明细.1">需求明细</h3><ol><li>针对 符合条件 的提货卡充值订单发生退款时, 计算出 抵扣充值预估毛利, 记为 考核毛利额 . 且用不同的 original_type 来区分. </li><li>针对这部分订单,强行订正其 业务组 和  财务业绩归属渠道 成 提货卡口径的. (包括冻结和最新的. )  &gt;&gt;&gt;&gt;<span style="color: rgb(255,0,0);">这里考虑是否引入 业绩一级类目的概念</span></li></ol><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-计算步骤">计算步骤</h3><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-一、指定待追回的退款单">一、指定待追回的退款单</h4><p>条件: </p><p>1) 订单的退款时间为 当月 </p><p>2) 订单是 属于提货卡充值订单</p><p>3) 订单支付时间为 提货卡算毛利指定月份.(或者直接先指定为20年12月. 等到21年12月的时候再说)</p><p>4) 退款时间 跟 提货卡充值时间不在同一个月份</p><p><br/></p><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-二、计算每个退款单对应的充值抵扣预估毛利">二、计算每个退款单对应的 充值抵扣预估毛利</h4><p>1) 根据 订单上的订单号, 订单充值时间, 匹配上肉上传预估毛利表, 获得其 预估毛利率. 如果取不到,则默认 预估毛利率为 0 .</p><p>2) 根据公式,计算出其 充值抵扣预估毛利.    即 退款GMV * 该品牌的预估毛利 * -1   .   退款GMV详见前面的 <a href="54521590.html">3. 退款GMV</a></p><p><br/></p><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-三、生成记录并制定对应的字段(维度和数值)">三、生成记录并制定对应的字段(维度和数值)</h4><p>1) 单条退款单, 继承所有现有的订单相关的维度. (就像正常的退款流程一样. original_type=1时)</p><p>2) 单条退款单 上的  业务组(实货)  和 财务业绩最新归属渠道_实货口径 的值,强行置换成 提货卡口径的. 可见下面的结果表 &gt;&gt;&gt;&gt;<span style="color: rgb(255,0,0);">这里考虑是否引入 业绩一级类目的概念</span></p><p>3) 所有跟数值类相关的, 都置为0.  仅 考核毛利额(check_gross_profit) = 上面的 抵扣预估毛利额. </p><p><br/></p><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-四、合并回结果表(gross_profit_all)">四、合并回 结果表(gross_profit_all)</h4><p><strong>用不同的type,合并回结果表. </strong></p><p>下面这种case会导致这个 提货卡从充值到全额销卡,最终产生 负毛利. 不过没关系,因为这里没有体现 财务这边会手动补上一个预估毛利在12月份. </p><p>(提货卡充值订单的退款就是销卡)</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th colspan="1" class="confluenceTh">业务过程</th><th colspan="1" class="confluenceTh">备注</th><th colspan="1" class="confluenceTh">original_type</th><th class="confluenceTh">dt</th><th colspan="1" class="confluenceTh">GMV</th><th colspan="1" class="confluenceTh">退款GMV</th><th colspan="1" class="confluenceTh">考核GMV</th><th class="confluenceTh">线上的考核毛利额</th><th class="confluenceTh">业务组和业绩业务组</th><th colspan="1" class="confluenceTh">财务业绩最新归属渠道_实货口径  /  财务业绩最新归属渠道_提货卡口径渠道</th><th class="confluenceTh"><br/></th></tr><tr><td colspan="1" class="confluenceTd">12月充值提货卡</td><td colspan="1" class="confluenceTd">充值10万提货卡</td><td colspan="1" class="confluenceTd">0</td><td class="confluenceTd">20201215</td><td colspan="1" class="confluenceTd">10万</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">10万</td><td class="confluenceTd">0</td><td class="confluenceTd">卡券票/ B类1组</td><td colspan="1" class="confluenceTd">卡券票/ BD部</td><td class="confluenceTd"><br/></td></tr><tr><td rowspan="2" class="confluenceTd">后续销卡</td><td rowspan="2" class="confluenceTd">销卡10万提货卡</td><td colspan="1" class="confluenceTd">1</td><td class="confluenceTd">20200110</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">10万</td><td colspan="1" class="confluenceTd">-10万</td><td class="confluenceTd">0</td><td class="confluenceTd">卡券票/ B类1组</td><td colspan="1" class="confluenceTd">卡券票/ BD部</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">99(举个例子)</td><td class="confluenceTd">20200110</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0</td><td class="confluenceTd">-1.5万</td><td class="confluenceTd">B类1组/ B类1组</td><td colspan="1" class="confluenceTd"> BD部 / BD部</td><td class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><p><br/></p><h2 id="id-1.指定月份提货卡充值计算预估毛利已删除-三、新增产品化-抵扣转实货预估毛利">三、<span style="color: rgb(23,43,77);">新增产品化- 抵扣转实货预估毛利</span></h2><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-需求明细.2">需求明细</h3><ol><li>针对 符合条件 的提货卡 支付的订单,发生支付或者退款时, 计算出 抵扣转实货预估毛利. 将其直接记为 考核毛利额. 且用不同的 original_type 来区分</li><li>注意! 请注意!  当 为 正向订单时, 抵扣转实货预估毛利 为 <span style="color: rgb(255,0,0);">负数值</span>  进行抵扣.  当为逆向退款单时,抵扣转实货预估毛利为 <span style="color: rgb(255,0,0);">正数值</span>  进行补回. </li></ol><h3 id="id-1.指定月份提货卡充值计算预估毛利已删除-计算步骤.1">计算步骤</h3><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-一、指定待追回的订单或者退款单">一、指定待追回的订单或者退款单</h4><p>1) 当 订单支付时间或者退款时间为 当月</p><p>2) 当 订单是否为提货卡支付订单为 是 且 订单支付时的提货卡中包含 提货卡算毛利指定月份 时充值的提货卡 (可以先指定为20年12月)</p><p><br/></p><p><br/></p><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-二、计算每个订单/退款单对应的符合条件的提货hi卡及其预估毛利率明细">二、计算每个订单/退款单对应的  符合条件的 提货hi卡 及其预估毛利率 明细</h4><p>1) 计算出 每个订单/退款单 对应的被使用的提货hi卡中符合条件的那部分提货hi卡的 提货hi卡支付金额. </p><p><span style="color: rgb(255,0,0);">2) 对应的被使用的提货hi卡的充值时间 不等于 订单支付/退款时间(这部分是财务手动处理的. 很重要!! )</span></p><p>将 上肉上传预估毛利表 的订单维度,转化为 hi卡维度的 预估毛利率. 并根据 该订单对应的hi卡编号 去进行匹配.  如果取不到,则默认 预估毛利率为 0 .</p><p>符合条件: 仅需要 提货卡充值时间(订单支付时间) 在  提货卡算毛利指定月份.</p><p><br/></p><p>假设一:例如, 某订单为 2022年1月15日支付. 其中,使用hi卡支付3000元.  </p><p>这3000由5张hi卡构成. 分别为下图</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">hi卡类型</th><th class="confluenceTh">hi卡编号</th><th colspan="1" class="confluenceTh">hi卡支付金额</th><th colspan="1" class="confluenceTh">提货卡品牌名称</th><th class="confluenceTh">hi卡的充值时间</th><th colspan="1" class="confluenceTh">备注</th><th colspan="1" class="confluenceTh">预估毛利率</th></tr><tr><td class="confluenceTd">普通hi卡</td><td class="confluenceTd">000001</td><td colspan="1" class="confluenceTd">500</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">19年5月</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">提货hi卡</td><td class="confluenceTd">000002</td><td colspan="1" class="confluenceTd">2200</td><td colspan="1" class="confluenceTd">爸比船长</td><td class="confluenceTd">20年5月</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="highlight-green confluenceTd" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" data-highlight-colour="green">000003</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">200</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" data-highlight-colour="green">20年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.11111</td></tr><tr><td colspan="1" class="confluenceTd">提货hi卡</td><td colspan="1" class="confluenceTd">000004</td><td colspan="1" class="confluenceTd">30</td><td colspan="1" class="confluenceTd">爸比船长</td><td colspan="1" class="confluenceTd">21年5月</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">000005</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">70</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">21年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.22222</td></tr></tbody></table></div><p><br/></p><p><br/></p><p>假设二:例如, 某订单为 2021年12月15日支付. 其中,使用hi卡支付3000元.  </p><p>这3000由5张hi卡构成. 分别为下图</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">hi卡类型</th><th class="confluenceTh">hi卡编号</th><th colspan="1" class="confluenceTh">hi卡支付金额</th><th colspan="1" class="confluenceTh">提货卡品牌名称</th><th class="confluenceTh">hi卡的充值时间</th><th colspan="1" class="confluenceTh">备注</th><th colspan="1" class="confluenceTh">预估毛利率</th></tr><tr><td class="confluenceTd">普通hi卡</td><td class="confluenceTd">000001</td><td colspan="1" class="confluenceTd">500</td><td colspan="1" class="confluenceTd"><br/></td><td class="confluenceTd">19年5月</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">提货hi卡</td><td class="confluenceTd">000002</td><td colspan="1" class="confluenceTd">2200</td><td colspan="1" class="confluenceTd">爸比船长</td><td class="confluenceTd">20年5月</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="highlight-green confluenceTd" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" data-highlight-colour="green">000003</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">200</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" data-highlight-colour="green">20年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.11111</td></tr><tr><td colspan="1" class="confluenceTd">提货hi卡</td><td colspan="1" class="confluenceTd">000004</td><td colspan="1" class="confluenceTd">30</td><td colspan="1" class="confluenceTd">爸比船长</td><td colspan="1" class="confluenceTd">21年5月</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">000005</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">70</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">21年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><p><span style="color: rgb(255,0,0);">不符合条件</span></p><p><span style="color: rgb(255,0,0);">该提货hi卡充值和支付在同一个月</span></p><p><span style="color: rgb(255,0,0);">该条订单已经扣除了提货卡余额,所以财务不会预估. 因此不需要做抵扣流程</span></p></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td></tr></tbody></table></div><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-三、计算每个订单/退款单对应的抵扣转实货预估毛利">三、计算每个订单/退款单对应的  抵扣转实货预估毛利</h4><p>继承假设一: 仅针对上述符合条件的 提货hi卡支付明细进行换算</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">hi卡类型</th><th class="confluenceTh">hi卡编号</th><th colspan="1" class="confluenceTh">hi卡支付金额</th><th colspan="1" class="confluenceTh">提货卡品牌名称</th><th class="confluenceTh">hi卡的充值时间</th><th colspan="1" class="confluenceTh">备注</th></tr><tr><td class="highlight-green confluenceTd" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" data-highlight-colour="green">000003</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">200</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" data-highlight-colour="green">20年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">000005</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">70</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">21年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td></tr></tbody></table></div><p><br/></p><p><strong>1) 当订单为正向订单时(original_type为0) 时</strong></p><p>抵扣转实货预估毛利为   指定提货卡支付金额 * 该品牌的预估毛利 * -1 </p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 51.8144%;"><colgroup><col style="width: 6.63114%;"/><col style="width: 6.71009%;"/><col style="width: 9.15729%;"/><col style="width: 10.4204%;"/><col style="width: 10.2625%;"/><col style="width: 6.78903%;"/><col style="width: 8.13104%;"/><col style="width: 38.8396%;"/><col style="width: 2.60509%;"/></colgroup><tbody><tr><th class="confluenceTh">hi卡类型</th><th class="confluenceTh">hi卡编号</th><th colspan="1" class="confluenceTh">hi卡支付金额</th><th colspan="1" class="confluenceTh">提货卡品牌名称</th><th class="confluenceTh">hi卡的充值时间</th><th colspan="1" class="confluenceTh">备注</th><th colspan="1" class="confluenceTh">预估毛利率</th><th colspan="1" class="confluenceTh">抵扣转实货预估毛利</th><th colspan="1" class="confluenceTh"><br/></th></tr><tr><td class="highlight-green confluenceTd" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" data-highlight-colour="green">000003</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">200</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" data-highlight-colour="green">20年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.11111</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">=200 *  0.11111 * -1 =  -22.2222</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">000005</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">70</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">21年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.22222</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">= 70 * 0.22222 * -1 = -14.554</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td></tr></tbody></table></div><p>最终,该正向订单的 抵扣转实货预估毛利 为  <strong>-36.776</strong></p><p><br/></p><p><strong>2) 当订单为负向退款单时(original_type为1) 时</strong></p><p>则其 抵扣转实货预估毛利   = 指定提货卡支付退款金额 * 该品牌的预估毛利 *  .   </p><p>即 考核毛利额 = 指定提货卡支付金额* 退款比例 * 该品牌的预估毛利 .</p><p>(PS: 这里存在问题1和问题2 ) .  假设退款比例为100%</p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 51.8144%;"><colgroup><col style="width: 6.63114%;"/><col style="width: 6.71009%;"/><col style="width: 9.15729%;"/><col style="width: 10.4204%;"/><col style="width: 10.2625%;"/><col style="width: 6.78903%;"/><col style="width: 8.13104%;"/><col style="width: 38.8396%;"/><col style="width: 2.60509%;"/></colgroup><tbody><tr><th class="confluenceTh">hi卡类型</th><th class="confluenceTh">hi卡编号</th><th colspan="1" class="confluenceTh">hi卡支付金额</th><th colspan="1" class="confluenceTh">提货卡品牌名称</th><th class="confluenceTh">hi卡的充值时间</th><th colspan="1" class="confluenceTh">备注</th><th colspan="1" class="confluenceTh">预估毛利率</th><th colspan="1" class="confluenceTh">抵扣转实货预估毛利</th><th colspan="1" class="confluenceTh"><br/></th></tr><tr><td class="highlight-green confluenceTd" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" data-highlight-colour="green">000003</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">200</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" data-highlight-colour="green">20年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.11111</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">=200 *  0.11111 * -1 *  -100% =  22.2222</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">提货hi卡</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">000005</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">70</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">爸比船长</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">21年12月</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">符合条件</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">0.22222</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">= 70 * 0.22222 * -1  * -100%= 14.554</td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><br/></td></tr></tbody></table></div><p>最终,该逆向退款单的  抵扣转实货预估毛利 = 36.776.</p><p><br/></p><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-四、生成记录并制定对应的字段(维度和数值)">四、生成记录并制定对应的字段(维度和数值)</h4><p>1) 单条退款单, 继承所有现有的订单相关的维度. (就像正常的退款流程一样. original_type=1时)</p><p>2) 所有跟数值类相关的, 都置为0.  仅 考核毛利额(check_gross_profit) = 上面的 抵扣预估毛利额. </p><p><br/></p><h4 id="id-1.指定月份提货卡充值计算预估毛利已删除-五、合并回结果表(gross_profit_all)">五、合并回 结果表(gross_profit_all)</h4><p>1) <span>用不同的type,合并回结果表. </span></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th colspan="1" class="confluenceTh">业务过程</th><th colspan="1" class="confluenceTh">备注</th><th colspan="1" class="confluenceTh">original_type</th><th class="confluenceTh">dt</th><th colspan="1" class="confluenceTh">GMV</th><th colspan="1" class="confluenceTh">退款GMV</th><th colspan="1" class="confluenceTh">考核GMV</th><th class="confluenceTh">线上的考核毛利额</th><th class="confluenceTh">业务组/业绩业务组</th><th colspan="1" class="confluenceTh">财务业绩最新归属渠道_实货口径  /  财务业绩最新归属渠道_提货卡口径渠道</th><th class="confluenceTh"><br/></th></tr><tr><td colspan="1" class="confluenceTd">12月充值提货卡</td><td colspan="1" class="confluenceTd">充值10万提货卡</td><td colspan="1" class="confluenceTd">0</td><td class="confluenceTd">20201215</td><td colspan="1" class="confluenceTd">10万</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">10万</td><td class="confluenceTd">0</td><td class="confluenceTd">卡券票/ B类1组</td><td colspan="1" class="confluenceTd">卡券票/ BD部</td><td class="confluenceTd"><br/></td></tr><tr><td rowspan="2" class="confluenceTd">后续转实货</td><td rowspan="2" class="confluenceTd">10万实货,提货卡支付</td><td colspan="1" class="confluenceTd">0</td><td class="confluenceTd">20200110</td><td colspan="1" class="confluenceTd">10万</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">10万</td><td class="confluenceTd">1万</td><td class="confluenceTd">B类1组/ B类1组</td><td colspan="1" class="confluenceTd">BD部/ BD部</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">97</td><td class="confluenceTd">20200110</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0</td><td class="confluenceTd">-1.5万</td><td class="confluenceTd">B类1组/B类1组</td><td colspan="1" class="confluenceTd">BD部/ BD部</td><td class="confluenceTd"><br/></td></tr><tr><td rowspan="2" class="confluenceTd">后续转实货退款</td><td rowspan="2" class="confluenceTd">退款50%.即5万</td><td colspan="1" class="confluenceTd">1</td><td colspan="1" class="confluenceTd">20200115</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">5万</td><td colspan="1" class="confluenceTd">-5万</td><td colspan="1" class="confluenceTd">-0.5万</td><td colspan="1" class="confluenceTd">B类1组/B类1组</td><td colspan="1" class="confluenceTd">BD部/ BD部</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">96</td><td colspan="1" class="confluenceTd">20200115</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">0.75万</td><td colspan="1" class="confluenceTd">B类1组/B类1组</td><td colspan="1" class="confluenceTd">BD部/ BD部</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><p><br/></p><p><br/></p><p><br/></p><h1 id="id-1.指定月份提货卡充值计算预估毛利已删除-其他">其他</h1><h2 class="auto-cursor-target" id="id-1.指定月份提货卡充值计算预估毛利已删除-问题一清退场景问题">问题一 清退场景问题</h2><p><a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=56046652">提货卡口径GMV-退款 极端场景下业务问题</a></p><p>最终发现,因为清退不是严格按照原路退回的. 因此对该公式造成影响. 该问题还会影响到业绩统计. 即所有的 提货卡口径的GMV都会受到影响. </p><p>最终跟业务方 瑶瑶进行沟通,  决定先行hold. 等待评审后,再跟马总沟通协调方案. </p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 39.1216%;"><colgroup><col style="width: 18.7305%;"/><col style="width: 25.3902%;"/><col style="width: 14.8803%;"/><col style="width: 13.8398%;"/><col style="width: 27.1592%;"/></colgroup><tbody><tr><th class="confluenceTh">场景</th><th colspan="1" class="confluenceTh">计算方式</th><th class="confluenceTh">全额退款的毛利变化</th><th class="confluenceTh">理论清退的毛利报表</th><th colspan="1" class="confluenceTh">业务实际清退时</th></tr><tr><th class="confluenceTh">新增产品化- 抵扣转实货预估毛利</th><th colspan="1" class="confluenceTh">手动计算- 提货卡预估</th><td class="confluenceTd">10*10% =+1 万</td><td class="confluenceTd">10*10% = +1 万</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><th rowspan="2" class="confluenceTh"><p>提货卡转实货10万</p><p>实际毛利为15%</p></th><th colspan="1" class="confluenceTh">现有产品化</th><td class="confluenceTd">1.5万</td><td class="confluenceTd">1.5万</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><th colspan="1" class="confluenceTh">新增产品化- 抵扣转实货预估毛利</th><td class="confluenceTd">10*10%*-1 =-1 万</td><td class="confluenceTd">10*10%*-1 =+1 万</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><th class="confluenceTh">发生全额退款/清退</th><th colspan="1" class="confluenceTh">现有产品化</th><td class="confluenceTd">-1.5万</td><td class="confluenceTd">-1.5万</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><th class="confluenceTh"><br/></th><th colspan="1" class="confluenceTh">新增产品化- 抵扣转实货预估毛利</th><td class="confluenceTd">10*10%* =+1 万</td><td class="confluenceTd">10*10%* =+1 万</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><th class="confluenceTh"><br/></th><th colspan="1" class="confluenceTh"><br/></th><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><th class="confluenceTh">累计</th><th colspan="1" class="confluenceTh"><br/></th><td class="confluenceTd"><p>提货卡余额10万</p><p>毛利为 1万</p></td><td class="confluenceTd"><p>提货卡余额10万</p><p>毛利为 1万</p></td><td colspan="1" class="confluenceTd"><p>提货卡余额0万</p><p>毛利为 0万</p></td></tr></tbody></table></div><p><br/></p><p><br/></p><h2 class="auto-cursor-target" id="id-1.指定月份提货卡充值计算预估毛利已删除-问题二业务组和渠道归属为卡券票的问题">问题二 业务组和渠道归属为卡券票的问题</h2><p>本次调整是在 实货口径毛利中,强行加入 提货卡口径的毛利. 但是提货卡相关的订单的 业务组啥的都是实货口径的.导致无法聚合. 所以需要强行手动改掉! </p><p>即 当该订单为 提货卡充值扣回 订单时,则将 业务组和渠道订正为 提货卡口径的业务组和渠道的值</p><p><br/></p><h2 class="auto-cursor-target" id="id-1.指定月份提货卡充值计算预估毛利已删除-问题三原路退时,优先退提货卡问题">问题三 原路退时,优先退提货卡问题</h2><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-thumbnail" height="250" src="attachments/56046716/56048947.png" data-image-src="attachments/56046716/56048947.png" data-unresolved-comment-count="0" data-linked-resource-id="56048947" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-6_15-10-5.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="56046716" data-linked-resource-container-version="31"></span></p><p><br/></p><h2 id="id-1.指定月份提货卡充值计算预估毛利已删除-问题四关于提货卡充值时和实际使用时对应的业务组,渠道出现不一致的情况">问题四 关于提货卡充值时 和 实际使用时 对应的 业务组,渠道 出现不一致的情况</h2><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/56046716/56049071.png" data-image-src="attachments/56046716/56049071.png" data-unresolved-comment-count="0" data-linked-resource-id="56049071" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-6_16-17-55.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="56046716" data-linked-resource-container-version="31"></span></p><p><br/></p><p><br/></p><p><br/></p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56046716/56046717.png">image2020-12-30_17-39-19.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56046716/56048947.png">image2021-1-6_15-10-5.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56046716/56049071.png">image2021-1-6_16-17-55.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56046716/56050890.png">image2021-1-7_18-16-22.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 2023-12-19 10:52</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
