<!DOCTYPE html>
<html>
    <head>
        <title>产品组 : V2版本-已废弃</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">产品组</a></span>
                            </li>
                                                    <li>
                                <span><a href="70335729.html">01_数据逻辑及模型设计思路</a></span>
                            </li>
                                                    <li>
                                <span><a href="59212886.html">三、费用</a></span>
                            </li>
                                                    <li>
                                <span><a href="61057821.html">营销费用之优惠券</a></span>
                            </li>
                                                    <li>
                                <span><a href="54522107.html">2. 优惠券之采购营销费用(原名:业务线营销费用)</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            产品组 : V2版本-已废弃
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> 未知用户 (lei.xue)</span>, last modified on 2021-03-12
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 class="auto-cursor-target" id="V2版本已废弃-修订记录"><strong>修订记录</strong></h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th style="text-align: left;" class="confluenceTh"><p>版本号</p></th><th style="text-align: left;" class="confluenceTh"><p>内容</p></th><th style="text-align: left;" class="confluenceTh"><p>作者</p></th><th style="text-align: left;" class="confluenceTh"><p>时间</p></th><th colspan="1" style="text-align: left;" class="confluenceTh"><p>备注</p></th></tr></thead><tbody><tr><td colspan="1" class="confluenceTd">V2</td><td colspan="1" class="confluenceTd"><p>1.计算分摊占比的指标 从 GMV 改成 GMV-退款</p><p>2.新增降级兜底分摊的逻辑</p><p>3.新增监控告警</p></td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2020.12.18</td><td colspan="1" class="confluenceTd"><a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=54505170">20210107_渠道毛利报表数据逻辑1期</a></td></tr><tr><td colspan="1" class="confluenceTd">V2.1</td><td colspan="1" class="confluenceTd">新增 分摊时的订单池必须是 海拍客自营订单(sale_dc_id= 0或-1)</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021/03/04</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><h1 id="V2版本已废弃-/*&lt;![CDATA[*/div.rbtoc1702954322580{padding:0px;}div.rbtoc1702954322580ul{list-style:disc;margin-left:0px;}div.rbtoc1702954322580li{margin-left:0px;padding-left:0px;}/*]]&gt;*/修订记录#V2版本已废弃-修订记录#V2版本已废弃-概括#V2版本已废弃-概括V2版本--最新版--21年1月至今#V2版本已废弃-V2版本--最新"><style type='text/css'>/*<![CDATA[*/
div.rbtoc1702954322580 {padding: 0px;}
div.rbtoc1702954322580 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1702954322580 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1702954322580'>
<ul class='toc-indentation'>
<li><a href='#V2版本已废弃-修订记录'>修订记录</a></li>
<li><a href='#V2版本已废弃-'></a></li>
<li><a href='#V2版本已废弃-概括'>概括</a></li>
<li><a href='#V2版本已废弃-V2版本--最新版--21年1月至今'>V2版本 --最新版--21年1月至今</a>
<ul class='toc-indentation'>
<li><a href='#V2版本已废弃-数据结果'>数据结果</a></li>
<li><a href='#V2版本已废弃-名词字段'>名词字段</a></li>
<li><a href='#V2版本已废弃-计算步骤'>计算步骤</a>
<ul class='toc-indentation'>
<li><a href='#V2版本已废弃-一、产出实际海拍客承担优惠券金额流水(金额1)'>一、产出 实际海拍客承担优惠券金额流水(金额1)</a>
<ul class='toc-indentation'>
<li><a href='#V2版本已废弃-1.获取海拍客承担优惠券金额'>1.获取 海拍客承担优惠券金额</a></li>
<li><a href='#V2版本已废弃-2.判断充值券支付金额'>2.判断 充值券支付金额</a></li>
<li><a href='#V2版本已废弃-3.正逆向计算.计算其流水'>3. 正逆向计算. 计算其流水</a></li>
</ul>
</li>
<li><a href='#V2版本已废弃-二、优惠券是否由三大业务线承担--计算和判断采购相关的实际海拍客承担优惠券金额流水(金额1)'>二、优惠券是否由三大业务线承担--计算和判断 采购相关的 实际海拍客承担优惠券金额流水(金额1)</a></li>
<li><a href='#V2版本已废弃-三、判断该实际海拍客承担优惠券金额流水(金额1)明细是否需要分摊'>三、判断该实际海拍客承担优惠券金额流水(金额1) 明细是否需要分摊</a></li>
<li><a href='#V2版本已废弃-四、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)'>四、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出 实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)</a>
<ul class='toc-indentation'>
<li><a href='#V2版本已废弃-1.获取需要分摊的费用流水及其实际海拍客承担优惠券金额流水(金额1)'>1.获取 需要分摊的费用流水及其 实际海拍客承担优惠券金额流水(金额1)</a></li>
<li><a href='#V2版本已废弃-2.按照每一条优惠券费用流水,获取该平台优惠券对应的费用归属维度属性.即海拍客费用归属二级部门(即业务组,需要转化.以下简称业务组).一级类目集合和品牌名集合.'>2. 按照每一条优惠券费用流水,获取 该平台优惠券对应的 费用归属维度属性. 即  海拍客费用归属二级部门(即业务组,需要转化. 以下简称业务组) .  一级类目集合 和 品牌名集合.</a></li>
<li><a href='#V2版本已废弃-3.按照每一条优惠券费用流水,根据费用归属属性,定位关联的待分摊订单流水'>3.按照每一条优惠券费用流水,根据 费用归属属性 ,定位关联的待分摊订单流水</a></li>
<li><a href='#V2版本已废弃-4.按照每一条费用对应的订单流水,分别计算其占比'>4.按照每一条费用对应的订单流水,分别计算其占比</a></li>
<li><a href='#V2版本已废弃-5.产出每一条费用对应的订单流水明细表'>5.产出每一条费用对应的订单流水明细表</a></li>
<li><a href='#V2版本已废弃-6.聚合汇总被分摊到的订单流水明细的实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)'>6.聚合汇总 被分摊到的订单流水明细 的 实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4) </a></li>
<li><a href='#V2版本已废弃-7.将被分摊到的订单流水明细的实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)合并回主表'>7. 将 被分摊到的订单流水明细的 实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)  合并回主表</a></li>
</ul>
</li>
<li><a href='#V2版本已废弃-五、汇总采购营销费用'>五、汇总 采购营销费用</a>
<ul class='toc-indentation'>
<li><a href='#V2版本已废弃-采购营销费用=实际海拍客承担优惠券金额流水_不要均摊(金额2)+实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)'>采购营销费用 =  实际海拍客承担优惠券金额流水_不要均摊(金额2) + 实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4) </a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></h1><h1 id="V2版本已废弃-概括">概括</h1><p>本期V2需求在开发过程中,接到业务通知. 变更业务规则.  具体请参见 <a href="61057752.html">V3版本</a></p><h1 id="V2版本已废弃-V2版本--最新版--21年1月至今">V2版本 --最新版--21年1月至今</h1><h2 id="V2版本已废弃-数据结果">数据结果</h2><p>每一个正向和逆向的order对应的 (分摊后的) 采购营销费用.   &gt;&gt;&gt;这里回头要专门拉个会,统一一个名词定义. </p><p>注意! 在所有上游的加工过程中, 必须要将该字段 称之为 优惠券金额. 而不是 采购营销费用.</p><p>只有最后一步(dw_gross_profit_all_d), 汇总回来的时候,才算是 营销费用! </p><h2 id="V2版本已废弃-名词字段">名词字段</h2><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 32.8767%;"><colgroup><col style="width: 47.4623%;"/><col style="width: 48.8219%;"/><col style="width: 3.5844%;"/></colgroup><tbody><tr><th class="confluenceTh">名词</th><th class="confluenceTh">备注</th><th class="confluenceTh"><br/></th></tr><tr><td class="confluenceTd"><span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1)</span></td><td class="confluenceTd"><p>当优惠券归属一级部门为 三大业务线时,则 </p><p>= <span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_需要均摊(金额2) + 实际海拍客承担优惠券金额流水_不要均摊(金额3)</span></p></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_不要均摊(金额2)</span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)</span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)</span></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(255,0,0);">采购营销费用</span></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><h2 id="V2版本已废弃-计算步骤">计算步骤</h2><h3 id="V2版本已废弃-一、产出实际海拍客承担优惠券金额流水(金额1)">一、产出 <span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1)</span></h3><p>备注&gt; 严格来讲,下文所有计算逻辑都是按照 平台券 的视角来进行开展.  </p><p><br/></p><h4 id="V2版本已废弃-1.获取海拍客承担优惠券金额"><strong>1.获取 海拍客承担优惠券金额</strong></h4><p>即 <a class="external-link" href="https://caiwu.yangtuojia.com/settle-static/orderSettle.html" rel="nofollow">订单结算</a> 中 的 海拍客承担优惠券金额（元）</p><h4 id="V2版本已废弃-2.判断充值券支付金额">2.判断 充值券支付金额</h4><p style="text-align: left;"><span>需要优惠券标记充值券，如果优惠券为充值券，则该订单上的营销费用金额=优惠券金额-充值券支付金额。</span></p><p style="text-align: left;"><span>例如本次订单用了充值券50元，为海拍客承担，当时购买这个券用了10元，那么 实际海拍客承担优惠券金额流水 =50-10=40元。</span></p><h4 style="text-align: left;" id="V2版本已废弃-3.正逆向计算.计算其流水"><span>3. 正逆向计算. 计算其流水</span></h4><p><span>当 订单为 正向订单时,则 实际海拍客承担优惠券金额流水 = 海拍客承担优惠券金额 - 充值券支付金额</span></p><p><span>当 订单为 逆向订单时,则 实际海拍客承担优惠券金额流水 = (海拍客承担优惠券金额 - 充值券支付金额) * -退款比例</span></p><p><br/></p><p><span style="color: rgb(255,0,0);">V2新增: </span><span><span style="color: rgb(0,0,0);">删除 <span style="color: rgb(255,0,0);">PRD</span> 中原有关于&quot; 当为卡券票时,营销费用为 0&quot; 的逻辑! PS: 目前没在脚本里找到这部分逻辑有实现. 并且,瑶瑶反馈正向的没有置为0. 逆向的却被置为了0.要修复这个BUG</span></span></p><p><span><span style="color: rgb(0,0,0);">即 当 订单为 卡券票时,也要继续计算其  实际海拍客承担优惠券金额流水(金额1)!  </span></span></p><p><span><span style="color: rgb(0,0,0);"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="250" src="attachments/61057750/61057771.png" data-image-src="attachments/61057750/61057771.png" data-unresolved-comment-count="0" data-linked-resource-id="61057771" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-12_21-33-3.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61057750" data-linked-resource-container-version="3"></span></span></span></p><p><br/></p><div class="code panel pdl" style="border-width: 1px;">
 <div class="codeHeader panelHeader pdl hide-border-bottom" style="border-bottom-width: 1px;">
  <b class="code-title">SQL示例</b>
  <span class="collapse-source expand-control" style="display:none;"><span class="expand-control-icon icon">&nbsp;</span><span class="expand-control-text">展开源码</span></span>
  <span class="collapse-spinner-wrapper"></span>
 </div>
 <div class="codeContent panelContent pdl hide-toolbar"> 
  <pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence; collapse: true" data-theme="Confluence">select 
    pay_month,
    case when item_name like '%提货%' THEN '是提货卡' ELSE '非提货卡' END AS is_pickup,
    count(1),
    sum(coupon_amount_platform)
from dw_order_d
where dayid ='20210111'
    AND pay_month &lt;='202012'
    AND pay_month &gt;='202001'
    AND business_unit = '卡券票'
    AND bu_id = 0 
    AND coupon_amount_platform &gt; 0 

GROUP BY 
    pay_month,
    case when item_name like '%提货%' THEN '是提货卡' ELSE '非提货卡' END

order by PAY_MONTH</pre> 
 </div>
</div><p><br/></p><p><span><span style="color: rgb(0,0,0);">注意,此时 实际海拍客承担优惠券金额流水 可能会负数. </span></span></p><p><br/></p><h3 id="V2版本已废弃-二、优惠券是否由三大业务线承担--计算和判断采购相关的实际海拍客承担优惠券金额流水(金额1)"><strong>二、优惠券是否由三大业务线承担--计算和判断 采购相关的 <span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1)</span></strong></h3><p>当 实际海拍客承担优惠券金额流水 对应的 平台优惠券 对应的 海拍客费用归属一级部门 为 &quot;B类及长尾&quot;,&quot;大贸&quot;,&quot;进口品牌组&quot; 时,</p><p>则这部分 明细参与 后续的计算.  否则,不参与后续的计算.</p><p>(在业务上这部分费用视为 其他业务团队承担的费用.这里我们不考虑)</p><p><br/></p><h3 id="V2版本已废弃-三、判断该实际海拍客承担优惠券金额流水(金额1)明细是否需要分摊">三、判断该<span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1) </span>明细是否需要分摊</h3><p>业务规则详见 <a class="external-link" href="http://demo.yangtuojia.com/%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1/%E8%B4%A2%E5%8A%A1%E4%B8%AD%E5%BF%83/02_%E9%A1%B9%E7%9B%AE/201905_01_%E6%AF%9B%E5%88%A9%E6%8A%A5%E8%A1%A8/201905_%E9%A1%B9%E7%9B%AE_01%20%E6%AF%9B%E5%88%A9%E6%8A%A5%E8%A1%A8%E4%BA%A7%E5%93%81%E5%8C%96/#g=1&amp;p=%E4%B8%9A%E5%8A%A1%E7%BA%BF%E8%90%A5%E9%94%80%E8%B4%B9%E7%94%A8" rel="nofollow">PRD</a>.</p><p>(PS: 这里涉及到是按 提货卡口径进行判断,还是按实货口径进行判断. 后者是为了便于后续统计. 最终决定为 后者).</p><p><br/></p><p>此时,区分哪些 明细维度的 <strong><span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1) </span></strong>需要进行分摊. </p><p>如果需要分摊,则新增字段, 记为 <span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)</span></p><p>如果不需要分摊,则新增字段, 记为 <span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_不要均摊(金额2)</span></p><p><br/></p><p><br/></p><p>以下对这种明细,称之为 费用流水</p><p><span style="color: rgb(255,102,0);"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/61057750/61057772.png" data-image-src="attachments/61057750/61057772.png" data-unresolved-comment-count="0" data-linked-resource-id="61057772" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-12_22-26-23.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61057750" data-linked-resource-container-version="3"></span></span></p><h3 id="V2版本已废弃-四、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)">四、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)</span></h3><h4 id="V2版本已废弃-1.获取需要分摊的费用流水及其实际海拍客承担优惠券金额流水(金额1)"><strong>1.获取 需要分摊的费用流水及其 </strong><span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1)</span></h4><p>当判断该费用流水按照上面的流程为 需要分摊时,则进行下面的流程. 如果判断该流程不需要分摊,则不需要该流程.直接跳到 五</p><p><br/></p><h4 id="V2版本已废弃-2.按照每一条优惠券费用流水,获取该平台优惠券对应的费用归属维度属性.即海拍客费用归属二级部门(即业务组,需要转化.以下简称业务组).一级类目集合和品牌名集合.">2. 按照每一条优惠券费用流水,获取 该平台优惠券对应的 费用归属维度属性. 即  海拍客费用归属二级部门(即业务组,需要转化. 以下简称业务组) .  一级类目集合 和 品牌名集合.</h4><p><br/></p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="215" src="attachments/61057750/61057773.png" data-image-src="attachments/61057750/61057773.png" data-unresolved-comment-count="0" data-linked-resource-id="61057773" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-13_10-40-4.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61057750" data-linked-resource-container-version="3"></span></p><p><br/></p><p><br/></p><h4 id="V2版本已废弃-3.按照每一条优惠券费用流水,根据费用归属属性,定位关联的待分摊订单流水">3.按照每一条优惠券费用流水,根据 费用归属属性 ,定位关联的待分摊订单流水</h4><p>按照获取到的三个 费用归属维度属性(业务组,一级类目,品牌名) 去订单退款流水中去定位哪些订单符合关联条件.  </p><p>请注意! 这里是涉及到两波订单. 一波是本身的毛利报表数据,即对应的 优惠券费用流水.   一波是额外的订单池. 是当需要分摊时,是为了定位需要参与分摊的订单. </p><p><br/></p><p><strong> 1) 当 品牌集合不为空时</strong></p><p>需要符合以下条件来判断订单号是否符合要求.  </p><p>    (1) 订单上的 业务组 = 平台优惠券上的 业务组</p><p>    (2) 订单上的 一级类目名称 包含在 平台优惠券上的 一级类目集合</p><p>    (3) 订单上的 品牌 包含在 平台优惠券上的 品牌集合</p><p>    (4) 订单流水时间(支付/退款)为 当月</p><p>    (5) 该订单 必须为 海拍客自营订单( sale_dc_id = 0 或者 -1 ) <span style="color: rgb(255,0,0);">V2.1新增</span></p><p><br/></p><p><strong> 2) 当 品牌集合为空时</strong></p><p>需要符合以下条件来判断订单号是否符合要求.  </p><p>    (1) 订单上的 业务组 = 平台优惠券上的 业务组</p><p>    (2) 订单上的 一级类目名称 包含在 平台优惠券上的 一级类目集合</p><p>    (3) 订单流水时间(支付/退款)为 当月</p><p>    (4) 该订单 必须为 海拍客自营订单( sale_dc_id = 0 或者 -1 ) <span style="color: rgb(255,0,0);">V2.1新增</span></p><p><br/></p><p>计算的过程来讲,是每一个优惠券费用流水 都会对应着多个订单. </p><p>因此会有多个 优惠券 存在一样的 费用归属配置. 因此可能多个优惠券对应着同一批订单.  但是要应该保证独立计算</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/61057750/61057774.png" data-image-src="attachments/61057750/61057774.png" data-unresolved-comment-count="0" data-linked-resource-id="61057774" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-13_11-7-24.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61057750" data-linked-resource-container-version="3"></span></p><p><br/></p><p><br/></p><p><strong> 3) 降低兜底分摊逻辑--<span style="color: rgb(255,0,0);"> 极度重要!  V2新增内容</span></strong></p><p>当执行了 1) 和 2) , 定位有部分 费用还是分摊不到,则 进行降级判断.(即强制去掉 类目,品牌 的判断,扩大范围)</p><p>需要符合以下条件来判断订单号是否符合要求.  </p><p>    (1) 订单上的 业务组 = 平台优惠券上的 业务组</p><p>    (2) 订单流水时间(支付/退款)为 当月</p><p>    (3) 该订单 必须为 海拍客自营订单( sale_dc_id = 0 或者 -1 ) <span style="color: rgb(255,0,0);">V2.1新增</span></p><p><br/></p><h4 id="V2版本已废弃-4.按照每一条费用对应的订单流水,分别计算其占比">4.按照每一条费用对应的订单流水,分别计算其占比</h4><p>分别计算出每一条费用流水的 实货GMV-退款占比, 并计算理论的每一条订单的 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)  </span></p><p><span style="color: rgb(0,0,0);">实货GMV-退款 的逻辑,可参见 <strong><a href="54522053.html">99. 计算分摊占比的指标</a> </strong>.  另外,因为是按月截止分摊. 因此退款也是截止到当月最后一天即可.</span></p><p><br/></p><p>单条费用的单条订单的 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4) </span><span style="color: rgb(255,102,0);"><span style="color: rgb(0,51,102);">=    单条订单的实货GMV-退款 / 该费用对应的所有订单的GMV-退款的总额 *  实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)</span></span></p><p style="text-align: left;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/61057750/61057775.png" data-image-src="attachments/61057750/61057775.png" data-unresolved-comment-count="0" data-linked-resource-id="61057775" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-13_11-7-34.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="61057750" data-linked-resource-container-version="3"></span></p><p><br/></p><h4 id="V2版本已废弃-5.产出每一条费用对应的订单流水明细表">5.产出每一条费用对应的订单流水明细表</h4><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">字段</th><th class="confluenceTh">备注</th></tr><tr><td class="confluenceTd">主键id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">优惠券费用流水对应着原有的订单的 trade_no,order_id</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">优惠券费用流水对应着原有的订单的 original_type</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">优惠券费用流水对应着原有的订单的 <span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">费用归属的二级部门(业务组)</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">费用归属的一级类目集合(中文名)</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">费用归属的品牌名集合(中文名)</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">---------------------------以下为明细维度</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 trade_no,order_id</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 original_type</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 业务组,一级类目,品牌名</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 实货GMV-退款</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">该优惠券对应的订单的 实货GMV-退款 之和</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(204,153,255);"><span style="color: rgb(0,0,0);">被分摊到的订单流水明细的</span> 实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h4 id="V2版本已废弃-6.聚合汇总被分摊到的订单流水明细的实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)">6.聚合汇总 被分摊到的订单流水明细 的 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4) </span></h4><p>即1个订单可能会被大量的优惠券进行分摊. 导致明细过多. </p><p>在这一层进行聚合. </p><h4 id="V2版本已废弃-7.将被分摊到的订单流水明细的实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)合并回主表">7. 将 被分摊到的订单流水明细的 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)  <span style="color: rgb(0,0,0);">合并回主表</span></span></h4><p>这里依赖我们数据模型的设计. 到底是先在现有的基础上改,还有彻底改成 数据类型和业务类型做拆分的流水表.(因为业务要考虑到本地的数据量的问题. 我们可先做流水表,再按业务需求打成现有的模式)</p><p>以下先用前者解释</p><h3 id="V2版本已废弃-五、汇总采购营销费用">五、汇总 <span style="color: rgb(255,0,0);">采购营销费用</span></h3><h4 id="V2版本已废弃-采购营销费用=实际海拍客承担优惠券金额流水_不要均摊(金额2)+实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)"><span style="color: rgb(255,0,0);">采购营销费用 =  <span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_不要均摊(金额2) </span>+ </span><span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4) </span></h4><p><span style="color: rgb(0,0,0);">注意! 这里的两个指标,前者本来就已经在现有的 订单流水上, 后者是通过在 7 ,合并回来的. </span></p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/61057750/61057771.png">image2021-1-12_21-33-3.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/61057750/61057772.png">image2021-1-12_22-26-23.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/61057750/61057773.png">image2021-1-13_10-40-4.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/61057750/61057774.png">image2021-1-13_11-7-24.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/61057750/61057775.png">image2021-1-13_11-7-34.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 2023-12-19 10:52</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
