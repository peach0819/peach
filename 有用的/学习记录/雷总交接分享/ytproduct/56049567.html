<!DOCTYPE html>
<html>
    <head>
        <title>产品组 : 3. 优惠券之渠道营销费用</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">产品组</a></span>
                            </li>
                                                    <li>
                                <span><a href="70335729.html">01_数据逻辑及模型设计思路</a></span>
                            </li>
                                                    <li>
                                <span><a href="59212886.html">三、费用</a></span>
                            </li>
                                                    <li>
                                <span><a href="61057821.html">营销费用之优惠券</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            产品组 : 3. 优惠券之渠道营销费用
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> 未知用户 (lei.xue)</span>, last modified on 2022-06-16
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 class="auto-cursor-target" id="id-3.优惠券之渠道营销费用-修订记录"><strong>修订记录</strong></h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th style="text-align: left;" class="confluenceTh"><p>sho版本号</p></th><th style="text-align: left;" class="confluenceTh"><p>内容</p></th><th style="text-align: left;" class="confluenceTh"><p>作者</p></th><th style="text-align: left;" class="confluenceTh"><p>时间</p></th><th colspan="1" style="text-align: left;" class="confluenceTh"><p>备注</p></th></tr></thead><tbody><tr><td colspan="1" class="confluenceTd">V1</td><td colspan="1" class="confluenceTd">新增渠道营销费用</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2020.12.18</td><td colspan="1" class="confluenceTd"><a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=54505170">20210107_渠道毛利报表数据逻辑1期</a></td></tr><tr><td colspan="1" class="confluenceTd">V1.1</td><td colspan="1" class="confluenceTd">新增 分摊时的订单池必须是 海拍客自营订单(sale_dc_id= 0或-1)</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021.03.04</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">V1.2</td><td colspan="1" class="confluenceTd">新增 加价券的排除逻辑</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021.03.16</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">V1.3</td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">新增 找订单时不能找到指定直播店订单的逻辑</span></td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021.03.30</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">V1.4</td><td colspan="1" class="confluenceTd">修改了 直播店的逻辑</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021.06.23</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">V1.5</td><td colspan="1" class="confluenceTd"><p>修改 分摊时, <span style="color: rgb(0,51,102);">财务业绩归属渠道 从 之前的 库内 改成 冻结. </span></p><p><span style="color: rgb(0,51,102);">因为都是当月,所以实际上数据不会变化.</span><span style="color: rgb(0,51,102);">但会影响 增值服务工单. 符合期望</span></p><p><span style="color: rgb(0,51,102);">(这里会影响逆向营销费用时的分摊. 但是符合期望) </span></p></td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021.08.24</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">V1.6</td><td colspan="1" class="confluenceTd">把上面V1.5改动的地方再改回去. 目前的逻辑跟 逆向的考核GMV 的承担不一致</td><td colspan="1" class="confluenceTd">阿雷</td><td colspan="1" class="confluenceTd">2021.09.03</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1702954323985 {padding: 0px;}
div.rbtoc1702954323985 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1702954323985 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1702954323985'>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-修订记录'>修订记录</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-引用'>引用</a></li>
</ul>
</li>
<li><a href='#id-3.优惠券之渠道营销费用-业务背景'>业务背景</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-V1版本--最新版--21年1月至今'>V1版本 --最新版--21年1月至今</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-公式'>公式</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-名词字段'>名词字段</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-计算步骤'>计算步骤</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-一、产出实际海拍客承担优惠券金额流水(金额1)'>一、产出 实际海拍客承担优惠券金额流水(金额1)</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-1.获取海拍客承担优惠券金额'>1.获取 海拍客承担优惠券金额</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-2.判断充值券支付金额'>2.判断 充值券支付金额</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-3.正逆向计算.计算其流水'>3. 正逆向计算. 计算其流水</a></li>
</ul>
</li>
<li><a href='#id-3.优惠券之渠道营销费用-二、判断是否要进行分摊'>二、判断是否要进行分摊</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-1.获取费用流水对应的'>1.获取 费用流水对应的 2. 优惠券渠道承担方</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-2.判断是否一致以及是否需要分摊'>2.判断是否一致以及是否需要分摊</a></li>
</ul>
</li>
<li><a href='#id-3.优惠券之渠道营销费用-三、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]'>三、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出 [实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-1.获取需要分摊的费用流水及其[实际海拍客承担优惠券金额流水(金额1)]'>1.获取 需要分摊的费用流水及其 [实际海拍客承担优惠券金额流水(金额1)]</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-2.按照每一条优惠券费用流水,实际的,定位关联的待分摊订单流水'>2. 按照每一条优惠券费用流水,实际的 2. 优惠券渠道承担方,定位关联的待分摊订单流水</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-4.按照每一条费用对应的订单流水,分别计算其占比'>4.按照每一条费用对应的订单流水,分别计算其占比</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-5.产出每一条费用对应的订单流水明细表'>5.产出每一条费用对应的订单流水明细表</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-6.聚合汇总被分摊到的订单流水明细的[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]即1个订单可能会被大量的优惠券进行分摊.导致明细过多.'>6.聚合汇总 被分摊到的订单流水明细 的 [实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)] 即1个订单可能会被大量的优惠券进行分摊. 导致明细过多. </a></li>
<li><a href='#id-3.优惠券之渠道营销费用-7.将被分摊到的订单流水明细的[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]合并回主表'>7. 将 被分摊到的订单流水明细的 [实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)] 合并回主表</a></li>
</ul>
</li>
<li><a href='#id-3.优惠券之渠道营销费用-四、汇总[渠道营销费用]'>四、汇总 [渠道营销费用]</a>
<ul class='toc-indentation'>
<li><a href='#id-3.优惠券之渠道营销费用-[渠道营销费用]=[实际海拍客承担优惠券金额流水_不要均摊(金额2)]+[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]'>[渠道营销费用] =  [实际海拍客承担优惠券金额流水_不要均摊(金额2)] + [实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href='#id-3.优惠券之渠道营销费用-监控预警'>监控预警</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-Q&amp;A'>Q&amp;A</a></li>
<li><a href='#id-3.优惠券之渠道营销费用-其他'>其他</a></li>
</ul>
</div></p><h2 id="id-3.优惠券之渠道营销费用-引用"><strong>引用</strong></h2><p><a class="external-link" href="http://demo.yangtuojia.com/%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1/%E8%B4%A2%E5%8A%A1%E4%B8%AD%E5%BF%83/02_%E9%A1%B9%E7%9B%AE/201905_01_%E6%AF%9B%E5%88%A9%E6%8A%A5%E8%A1%A8/201905_%E9%A1%B9%E7%9B%AE_01%20%E6%AF%9B%E5%88%A9%E6%8A%A5%E8%A1%A8%E4%BA%A7%E5%93%81%E5%8C%96/#g=1&amp;p=%E4%B8%9A%E5%8A%A1%E6%AF%9B%E6%94%B6%E5%85%A5" rel="nofollow" style="text-decoration: none;">采购毛利报表一期</a></p><h1 id="id-3.优惠券之渠道营销费用-业务背景">业务背景</h1><p>详见 <a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=54522107#id-5.%E9%87%87%E8%B4%AD%E8%90%A5%E9%94%80%E8%B4%B9%E7%94%A8(%E5%8E%9F%E5%90%8D:%E4%B8%9A%E5%8A%A1%E7%BA%BF%E8%90%A5%E9%94%80%E8%B4%B9%E7%94%A8)%E6%9C%AA%E5%AE%8C%E5%96%84-%E4%B8%9A%E5%8A%A1%E8%83%8C%E6%99%AF" rel="nofollow">采购营销费用</a></p><h1 id="id-3.优惠券之渠道营销费用-V1版本--最新版--21年1月至今">V1版本 --最新版--21年1月至今</h1><h2 id="id-3.优惠券之渠道营销费用-公式">公式</h2><p><span style="color: rgb(23,43,77);">每一个正向和逆向的order对应的 (分摊后的) 渠道营销费用.</span></p><p>注意! 在所有上游的加工过程中, 必须要将该字段 称之为 优惠券金额. 而不是 渠道营销费用.</p><p>只有最后一步(dw_gross_profit_all_d), 汇总回来的时候,才算是 渠道营销费用! </p><h2 id="id-3.优惠券之渠道营销费用-名词字段">名词字段</h2><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 32.8767%;"><colgroup><col style="width: 47.4623%;"/><col style="width: 48.8219%;"/><col style="width: 3.5844%;"/></colgroup><tbody><tr><th class="confluenceTh">名词</th><th class="confluenceTh">备注</th><th class="confluenceTh"><br/></th></tr><tr><td class="confluenceTd"><span style="color: rgb(0,0,255);">[实际海拍客承担优惠券金额流水(金额1)]</span></td><td class="confluenceTd"><p>= <span style="color: rgb(255,102,0);">[实际海拍客承担优惠券金额流水_不要均摊(金额2)]</span><span style="color: rgb(255,102,0);">+ [实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)]</span></p></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><span style="color: rgb(255,102,0);">[实际海拍客承担优惠券金额流水_不要均摊(金额2)]</span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><span style="color: rgb(255,102,0);">[实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)]</span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(204,153,255);">[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]</span></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(255,0,0);">[渠道营销费用]</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(255,0,0);">[渠道营销费用] = <span style="color: rgb(204,153,255);">[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)] + <span style="color: rgb(255,102,0);">[实际海拍客承担优惠券金额流水_不要均摊(金额2)]</span></span></span></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><h2 id="id-3.优惠券之渠道营销费用-计算步骤">计算步骤</h2><h3 style="" id="id-3.优惠券之渠道营销费用-一、产出实际海拍客承担优惠券金额流水(金额1)">一、产出 <span style="color: rgb(0,0,255);">实际海拍客承担优惠券金额流水(金额1)</span></h3><p style="">请参见 <a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=94764949" rel="nofollow" style="text-decoration: none;">0. 实际海拍客承担优惠券金额流水(金额1)</a></p><h4 id="id-3.优惠券之渠道营销费用-1.获取海拍客承担优惠券金额"><strong>1.获取 海拍客承担优惠券金额</strong></h4><p>即 <a class="external-link" href="https://caiwu.yangtuojia.com/settle-static/orderSettle.html" rel="nofollow">订单结算</a> 中 的 海拍客承担优惠券金额（元）</p><h4 id="id-3.优惠券之渠道营销费用-2.判断充值券支付金额">2.判断 充值券支付金额</h4><p style="text-align: left;"><span>需要优惠券标记充值券，如果优惠券为充值券，则该订单上的营销费用金额=优惠券金额-充值券支付金额。</span></p><p style="text-align: left;"><span>例如本次订单用了充值券50元，为海拍客承担，当时购买这个券用了10元，那么 <span style="color: rgb(0,0,255);">[实际海拍客承担优惠券金额流水(金额1)]</span> =50-10=40元。</span></p><h4 style="text-align: left;" id="id-3.优惠券之渠道营销费用-3.正逆向计算.计算其流水"><span>3. 正逆向计算. 计算其流水</span></h4><p><span>当 订单为 正向订单时,则 <span style="color: rgb(0,0,255);">[实际海拍客承担优惠券金额流水(金额1)] </span></span><span>= 海拍客承担优惠券金额 - 充值券支付金额</span></p><p><span>当 订单为 逆向订单时,则 <span style="color: rgb(0,0,255);">[实际海拍客承担优惠券金额流水(金额1)]</span> = (海拍客承担优惠券金额 - 充值券支付金额) * -退款比例</span></p><p><span><span style="color: rgb(0,0,0);">注意,此时 实际海拍客承担优惠券金额流水 可能会负数. </span></span></p><p><br/></p><p><span><span style="color: rgb(0,0,0);">以下对所有正逆向的 优惠券金额的明细, 简称为 优惠券费用流水</span></span></p><p><br/></p><h3 id="id-3.优惠券之渠道营销费用-二、判断是否要进行分摊">二、判断是否要进行分摊</h3><h4 id="id-3.优惠券之渠道营销费用-1.获取费用流水对应的"><strong>1.获取 费用流水对应的 <a href="54522089.html">2. 优惠券渠道承担方</a></strong></h4><p>详见PRD.此前的需求中,单独对其进行定义. 就是为了在这里判断. </p><h4 id="id-3.优惠券之渠道营销费用-2.判断是否一致以及是否需要分摊"><strong>2.判断是否一致以及是否需要分摊</strong></h4><p><span style="color: rgb(255,0,0);">注意! 这里可能出现 一个定义,但是名词对不上的情况. 例如 BD,bd,BD部,bd部 这四个值,其实是一个定义. </span></p><p><span style="color: rgb(255,0,0);"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="400" src="attachments/56049567/62712552.png" data-image-src="attachments/56049567/62712552.png" data-unresolved-comment-count="0" data-linked-resource-id="62712552" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-4-15_17-3-1.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="56049567" data-linked-resource-container-version="36"></span></span></p><p><br/></p><p>1) 当 渠道优惠券承担方 = 订单上的 财务业绩归属渠道_实货口径,则  <span style="color: rgb(0,51,102);"> <span style="color: rgb(255,0,255);">(V1.5改成 冻结财务业绩归属渠道, V1.6改回 最新财务业绩归属渠道) </span></span></p><p>该条流水不需要进行分摊. 且获得字段 [<span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_不要均摊(金额2)]</span></p><p><br/></p><p><span style="color: rgb(0,51,102);">2) 当 渠道优惠券承担方 != 订单上的 财务业绩归属渠道_实货口径,则     <span style="color: rgb(255,0,255);">(V1.5改成 冻结财务业绩归属渠道, V1.6改回 最新财务业绩归属渠道) </span><br/>该条流水需要进行分摊,且获得字段 [<span style="color: rgb(255,102,0);">实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)]. <span style="color: rgb(0,0,0);">并执行 三 的分摊逻辑</span></span></span></p><p><br/></p><h3 id="id-3.优惠券之渠道营销费用-三、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]">三、对该分摊的费用流水进行分摊,并聚合汇总,合并,产出 <span style="color: rgb(204,153,255);">[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]</span></h3><h4 id="id-3.优惠券之渠道营销费用-1.获取需要分摊的费用流水及其[实际海拍客承担优惠券金额流水(金额1)]"><strong>1.获取 需要分摊的费用流水及其 </strong><span style="color: rgb(0,0,255);">[实际海拍客承担优惠券金额流水(金额1)]</span></h4><p>当判断该费用流水按照上面的流程为 需要分摊时,则进行下面的流程. 如果判断该流程不需要分摊,则不需要该流程.直接跳到 五</p><h4 id="id-3.优惠券之渠道营销费用-2.按照每一条优惠券费用流水,实际的,定位关联的待分摊订单流水">2. 按照每一条优惠券费用流水,实际的<strong> <a href="54522089.html">2. 优惠券渠道承担方</a></strong>,定位关联的待分摊订单流水</h4><p><span style="color: rgb(255,0,0);">请注意! 这里是涉及到两波订单. 一波是本身的毛利报表数据,即对应的 优惠券费用流水.   一波是额外的订单池. 是当需要分摊时,是为了定位需要参与分摊的订单. </span></p><p><br/></p><p>需要符合以下条件来判断是否符合要求</p><p><strong>1) 当 <span style="color: rgb(0,51,102);">优惠券费用流水 上的 海拍客费用归属一级类目 不为空</span></strong></p><p>    (1) 被定位的订单流水<span style="color: rgb(0,51,102);">上的 财务业绩归属渠道_实货口径 = 优惠券费用流水上的渠道优惠券承担方  <span style="color: rgb(255,0,255);">(V1.5改成 冻结财务业绩归属渠道, V1.6改回 最新财务业绩归属渠道) </span></span></p><p><span style="color: rgb(0,51,102);">    (2) 订单流水时间 = 当月</span></p><p><span style="color: rgb(0,51,102);">    (3) <span style="color: rgb(23,43,77);">订单上的 一级类目名称 包含在 平台优惠券上的 一级类目集合</span></span></p><p><span style="color: rgb(0,51,102);">    (4) 如果平台优惠券有品牌,则 <span style="color: rgb(23,43,77);">订单上的 品牌 包含在 平台优惠券上的 品牌集合. 否则,则不需要判断该条件</span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);">    (5) 被定位的订单流水上的 门店省份,城市 = 优惠券费用流水上的订单的 门店省份,城市  </span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);">    (6) 该订单 必须为 海拍客自营订单( sale_dc_id = 0 或者 -1 )<span> </span><span style="color: rgb(255,0,0);">V1.1新增</span></span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);"><span style="color: rgb(255,0,0);">  <span style="color: rgb(0,0,0);">  (7) 被定位的订单流水上的 本身的 优惠券采购承担方  不能为  加价券 和 特殊其他</span> (V1.2新增)</span></span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);"><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">    (8) shop_id != 'bcfb591b919e48e1804fcdce670c6b55'      <span style="color: rgb(255,0,0);">V1.3新增</span> (源于 <a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=62687112">202103_日常_抖音直播订单隔离方案</a>)</span></span></span></span></p><p><br/></p><p><strong>2) 当 <span style="color: rgb(0,51,102);">优惠券费用流水 上的 海拍客费用归属一级类目 为空</span></strong></p><p>    (1) 被定位的订单流水<span style="color: rgb(0,51,102);">上的 财务业绩归属渠道_实货口径 = 优惠券费用流水上的渠道优惠券承担方     <span style="color: rgb(255,0,255);">(V1.5改成 冻结财务业绩归属渠道, V1.6改回 最新财务业绩归属渠道) </span></span></p><p><span style="color: rgb(0,51,102);">    (2) 订单流水时间 = 当月</span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);">    (3) 被定位的订单流水上的 门店省份,城市 = 优惠券费用流水上的订单的 门店省份,城市  </span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);">    (4) 该订单 必须为 海拍客自营订单( sale_dc_id = 0 或者 -1 )<span> </span><span style="color: rgb(255,0,0);">V1.1新增</span></span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);"><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">    (5) 被定位的订单流水上的 本身的 优惠券渠道承担方  不能为  加价券 和 特殊其他</span> (V1.2新增)</span></span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);"><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">    (6) shop_id != 'bcfb591b919e48e1804fcdce670c6b55'      V1.3新增 (源于 <a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=62687112">202103_日常_抖音直播订单隔离方案</a>)</span></span></span></span></p><p><br/></p><p><br/></p><p>计算的过程来讲,是每一个优惠券费用流水 都会对应着多个订单. </p><p>因此会有多个 优惠券 存在一样的 费用归属配置. 因此可能多个优惠券对应着同一批订单.  但是要应该保证独立计算</p><p>下图是 采购的优惠券分摊逻辑. 仅做参考</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/56049567/57055784.png" data-image-src="attachments/56049567/57055784.png" data-unresolved-comment-count="0" data-linked-resource-id="57055784" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-13_11-7-24.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="56049567" data-linked-resource-container-version="36"></span></p><p><br/></p><p><span style="color: rgb(0,51,102);"><strong>3) 降低兜底分摊逻辑--<span style="color: rgb(255,0,0);"> 极度重要! </span></strong></span></p><p>当执行了 1) 和 2) , 定位有部分 费用还是分摊不到,则 进行降级判断.(即强制去掉 类目,品牌 的判断,扩大范围)</p><p>需要符合以下条件来判断订单号是否符合要求.  </p><p>    (1) 被定位的订单流水<span style="color: rgb(0,51,102);">上的 财务业绩归属渠道_实货口径 = 优惠券费用流水上的渠道优惠券承担方    <span style="color: rgb(255,0,255);">(V1.5改成 冻结财务业绩归属渠道, V1.6改回 最新财务业绩归属渠道)  </span></span></p><p><span style="color: rgb(0,51,102);">    (2) <span style="color: rgb(23,43,77);">被定位的订单流水上的 </span>订单流水时间 = 当月</span></p><p><span style="color: rgb(0,51,102);">    <span style="color: rgb(23,43,77);">(3) 被定位的订单流水上的 必须为 海拍客自营订单( sale_dc_id = 0 或者 -1 )<span> </span><span style="color: rgb(255,0,0);">V1.1新增</span></span></span></p><p><span style="color: rgb(0,51,102);">    <span style="color: rgb(23,43,77);"><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">(4) 被定位的订单流水上的 本身的 优惠券渠道承担方  不能为  加价券 和 特殊其他</span> (V1.2新增)</span></span></span></p><p><span style="color: rgb(0,51,102);"><span style="color: rgb(23,43,77);"><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">    (5)  <span style="color: rgb(255,0,0);">V1.3新增 V1.4修改</span> <s>shop_id != 'bcfb591b919e48e1804fcdce670c6b55' </s>   门店不属于 门店分组(ID:1750)  来判断. 详见  <a class="external-link" href="https://onequery.yangtuojia.com/?id=12052" rel="nofollow" style="text-decoration: none;">SQL示例</a>    (需求源于<span> </span><a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=62687112" rel="nofollow" style="text-decoration: none;">202103_日常_抖音直播订单隔离方案</a>) </span></span></span></span></p><p><span style="color: rgb(0,51,102);">PS: 这里在业务验证的过程中,可能需要二次调整. 不排除为了精度问题,加上第二次兜底判断逻辑</span></p><p><br/></p><p><br/></p><h4 id="id-3.优惠券之渠道营销费用-4.按照每一条费用对应的订单流水,分别计算其占比">4.按照每一条费用对应的订单流水,分别计算其占比</h4><p>分别计算出每一条费用流水的 实货GMV-退款占比, 并计算理论的每一条订单的 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)  </span></p><p><span style="color: rgb(0,0,0);">实货GMV-退款 的逻辑,可参见 <strong><a href="54522053.html">99. 计算分摊占比的指标</a> </strong>.  另外,因为是按月截止分摊. 因此退款也是截止到当月最后一天即可.</span></p><p><br/></p><p>单条费用的单条订单的 <span style="color: rgb(204,153,255);">实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4) </span><span style="color: rgb(255,102,0);"><span style="color: rgb(0,51,102);">=    单条订单的实货GMV-退款 / 该费用对应的所有订单的GMV-退款的总额 *  实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)</span></span></p><p><span style="color: rgb(255,102,0);"><span style="color: rgb(0,51,102);">下图是 采购的优惠券分摊逻辑. 仅做参考</span></span></p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/56049567/57055791.png" data-image-src="attachments/56049567/57055791.png" data-unresolved-comment-count="0" data-linked-resource-id="57055791" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2021-1-13_11-7-34.png" data-base-url="http://k.yangtuojia.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="56049567" data-linked-resource-container-version="36"></span></p><p><br/></p><h4 id="id-3.优惠券之渠道营销费用-5.产出每一条费用对应的订单流水明细表">5.产出每一条费用对应的订单流水明细表</h4><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">字段</th><th class="confluenceTh">备注</th></tr><tr><td class="confluenceTd">主键id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">优惠券费用流水对应着原有的订单的 trade_no,order_id</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">优惠券费用流水对应着原有的订单的 original_type</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">优惠券费用流水对应着原有的订单的 <span style="color: rgb(255,102,0);">[实际海拍客承担优惠券金额流水_需要均摊_均摊前(金额3)]</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">费用归属的二级部门(业务组)</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">费用归属的一级类目集合(中文名)</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">费用归属的品牌名集合(中文名)</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">---------------------------以下为明细维度</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 trade_no,order_id</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 original_type</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 业务组,一级类目,品牌名</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">被分摊到的订单流水明细的 实货GMV-退款</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">该优惠券对应的订单的 实货GMV-退款 之和</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(204,153,255);"><span style="color: rgb(0,0,0);">被分摊到的订单流水明细的</span> 实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h4 id="id-3.优惠券之渠道营销费用-6.聚合汇总被分摊到的订单流水明细的[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]即1个订单可能会被大量的优惠券进行分摊.导致明细过多.">6.聚合汇总 被分摊到的订单流水明细 的 <span style="color: rgb(204,153,255);">[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)] </span>即1个订单可能会被大量的优惠券进行分摊. 导致明细过多. </h4><p>在这一层进行聚合.  聚合到单个订单在单个流水日期单个类型下一行</p><h4 id="id-3.优惠券之渠道营销费用-7.将被分摊到的订单流水明细的[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]合并回主表">7. 将 被分摊到的订单流水明细的 <span style="color: rgb(204,153,255);">[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)] </span><span style="color: rgb(204,153,255);"><span style="color: rgb(0,0,0);">合并回主表</span></span></h4><p>这里依赖我们数据模型的设计. 到底是先在现有的基础上改,还有彻底改成 数据类型和业务类型做拆分的流水表.(因为业务要考虑到本地的数据量的问题. 我们可先做流水表,再按业务需求打成现有的模式)</p><p>以下先用前者解释</p><p><br/></p><h3 id="id-3.优惠券之渠道营销费用-四、汇总[渠道营销费用]">四、汇总 <span style="color: rgb(255,0,0);">[渠道营销费用]</span></h3><h4 id="id-3.优惠券之渠道营销费用-[渠道营销费用]=[实际海拍客承担优惠券金额流水_不要均摊(金额2)]+[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]"><span style="color: rgb(255,0,0);">[渠道营销费用] =  <span style="color: rgb(255,102,0);">[实际海拍客承担优惠券金额流水_不要均摊(金额2)] </span>+ </span><span style="color: rgb(204,153,255);">[实际海拍客承担优惠券金额流水_需要均摊_均摊后(金额4)]</span></h4><p><span style="color: rgb(0,0,0);">注意! 这里的两个指标,前者本来就已经在现有的 订单流水上, 后者是通过在 7 ,合并回来的. </span></p><p><br/></p><p><br/></p><h1 id="id-3.优惠券之渠道营销费用-监控预警">监控预警</h1><p><span style="color: rgb(255,0,0);">保证以下预警规则T+1运行,且预警推送到 渠道毛利报表需求群中. </span></p><p><span style="color: rgb(255,0,0);">且保留SQL,保证告警了可以快速定位到. 可参见 <a class="external-link" href="https://meta.yangtuojia.com/front-static/dqc/monitordetail?id=294" rel="nofollow">DQC配置</a></span></p><p><span style="color: rgb(255,0,0);">请直接详见  <a href="http://k.yangtuojia.com/pages/viewpage.action?pageId=57077933" rel="nofollow">http://k.yangtuojia.com/pages/viewpage.action?pageId=57077933</a></span></p><p><br/></p><h1 id="id-3.优惠券之渠道营销费用-Q&amp;A"><strong>Q&amp;A</strong></h1><p><br/></p><h1 id="id-3.优惠券之渠道营销费用-其他"><strong>其他</strong></h1><p><br/></p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56049567/57055759.png">image2021-1-12_21-33-3.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56049567/57055784.png">image2021-1-13_11-7-24.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56049567/57055791.png">image2021-1-13_11-7-34.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/56049567/62712552.png">image2021-4-15_17-3-1.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 2023-12-19 10:52</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
